<!DOCTYPE html>
<html lang="da">
<head>
<meta charset="UTF-8">
<title>Risiko beregner Kronisk koronart syndrom</title>
<style>
  body { font-family: Arial, sans-serif; max-width: 700px; margin: 40px auto; }
  label { display: block; margin-top: 15px; font-weight: bold; }
  select, input { width: 100%; padding: 8px; margin-top: 5px; box-sizing: border-box; }
  button { margin-top: 20px; padding: 10px 15px; font-size: 1em; }
  #result { margin-top: 25px; padding: 15px; border: 1px solid #ccc; border-radius: 4px; }
  #heartHeader { display: flex; align-items: center; gap: 20px; padding: 15px 0 25px 0; border-bottom: 1px solid #ddd; }
  .heartIcon svg { width: 60px; height: 60px; }
  .heartText h1 { margin: 0; font-size: 1.8em; color: #b30000; }
  .heartText p { margin: 5px 0 0 0; color: #444; font-size: 0.95em; }
</style>
<link rel="manifest" href="manifest.json">

<script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('service-worker.js');
}
</script>

  
</head>

<body>

<div id="heartHeader">
  <div class="heartIcon">
    <svg viewBox="0 0 24 24">
      <path d="M12 21s-6.7-4.6-10-9.7C-1.3 6.3 1.2 2 5.5 2 8 2 10 3.7 12 6c2-2.3 4-4 6.5-4C22.8 2 25.3 6.3 22 11.3 18.7 16.4 12 21 12 21z"
            fill="#cc0000"/>
    </svg>
  </div>
  <div class="heartText">
    <h1>Kardiologisk risikovurdering</h1>
    <p>Vurdering af risiko for obstruktiv koronarsygdom baseret på ESC‑guidelines</p>
  </div>
</div>

<h2>Risiko beregner Kronisk koronart syndrom</h2>
<p>Beregner risiko for obstruktiv koronarsygdom i %. Fra ESC guidelines.</p>

<label>Symptom score (Smertekarakter)</label>
<select id="symptom">
  <option value="1">Trykken for brystet (1 point)</option>
  <option value="2">Trykken for brystet og forværret ved stress (2 point)</option>
  <option value="3">Ovennævnte lindret af hvile eller nitro (3 point)</option>
  <option value="2b">Dyspnø (2 point)</option>
</select>

<label>Køn</label>
<select id="sex">
  <option value="0">Kvinde</option>
  <option value="1">Mand</option>
</select>

<label>Antal risikofaktorer</label>
<select id="risk">
  <option value="0">0–1</option>
  <option value="1">2–3</option>
  <option value="2">4–5</option>
</select>

<label>Alder</label>
<input type="number" id="age" placeholder="fx 55">

<button onclick="calculate()">Beregn risiko</button>

<div id="result">
  <h3 id="riskValue"></h3>
  <p id="interpretation"></p>

  <p><strong>Nærmeste ESC‑værdi:</strong> <span id="nearestMid"></span></p>
  <p><strong>Referencepunkter:</strong> <span id="refPoints"></span></p>
  <p id="boundaryNote" style="color:#555;"></p>
</div>

<script>
// ESC table (18 columns per row)
const table = [
  { decade: "30-39", values: [0,1,2, 1,2,5, 0,1,3, 2,4,8, 2,5,10, 9,14,22] },
  { decade: "40-49", values: [1,1,3, 2,4,8, 1,2,5, 3,6,12, 4,7,12, 14,20,27] },
  { decade: "50-59", values: [1,2,5, 4,7,12, 2,3,7, 6,11,17, 6,10,15, 21,27,33] },
  { decade: "60-69", values: [2,4,7, 8,12,17, 3,6,11, 12,17,25, 10,14,19, 32,35,39] },
  { decade: "70-80", values: [4,7,11, 15,19,24, 6,10,16, 22,27,34, 16,19,23, 44,44,45] }
];

const ageMids = [35, 45, 55, 65, 75];

function toLogit(p) { return Math.log(p / (1 - p)); }
function fromLogit(L) { return 1 / (1 + Math.exp(-L)); }

function calculate() {
  const symptom = document.getElementById("symptom").value;
  const sex = parseInt(document.getElementById("sex").value);
  const risk = parseInt(document.getElementById("risk").value);
  const age = parseInt(document.getElementById("age").value);

  const riskEl = document.getElementById("riskValue");
  const interpEl = document.getElementById("interpretation");
  const nearestEl = document.getElementById("nearestMid");
  const refEl = document.getElementById("refPoints");
  const boundaryEl = document.getElementById("boundaryNote");

  if (isNaN(age)) {
    riskEl.textContent = "Angiv venligst en alder.";
    interpEl.textContent = "";
    nearestEl.textContent = "";
    refEl.textContent = "";
    boundaryEl.textContent = "";
    return;
  }

  let points = (symptom === "2b") ? 2 : parseInt(symptom);

  let pointGroup = 0;
  if (points === 2) pointGroup = 1;
  if (points >= 3) pointGroup = 2;

  let iLow, iHigh, w;

  if (age <= ageMids[0]) {
    iLow = 0; iHigh = 1;
    w = (age - ageMids[0]) / 10;
  } else if (age >= ageMids[4]) {
    iLow = 3; iHigh = 4;
    w = (age - ageMids[3]) / 10;
  } else {
    for (let i = 0; i < 4; i++) {
      if (age >= ageMids[i] && age <= ageMids[i+1]) {
        iLow = i; iHigh = i+1;
        break;
      }
    }
    w = (age - ageMids[iLow]) / 10;
  }

  function getProbForRF(rfIndex) {
    const col = pointGroup * 6 + sex * 3 + rfIndex;
    const pLow = table[iLow].values[col] / 100;
    const pHigh = table[iHigh].values[col] / 100;

    const eps = 1e-6;
    const L1 = toLogit(Math.min(Math.max(pLow, eps), 1-eps));
    const L2 = toLogit(Math.min(Math.max(pHigh, eps), 1-eps));

    return fromLogit(L1 + w * (L2 - L1));
  }

  let p0 = getProbForRF(0);
  let p1 = getProbForRF(1);
  let p2 = getProbForRF(2);

  if (p1 < p0) p1 = p0;
  if (p2 < p1) p2 = p1;

  let p = (risk === 0) ? p0 : (risk === 1 ? p1 : p2);

  let value = Math.round(p * 100);
  if (value > 50) value = 50;

  let text;
  if (value <= 5) text = "Billeddiagnostik ikke indiceret.";
  else if (value <= 15) text = "Billediagnostik kan overvejes.";
  else text = "Billediagnostik indiceret.";

  // ---- CORRECTED ESC DECADE REPORTING ----

  let decadeIndex;
  if (age < 40) decadeIndex = 0;
  else if (age < 50) decadeIndex = 1;
  else if (age < 60) decadeIndex = 2;
  else if (age < 70) decadeIndex = 3;
  else decadeIndex = 4;

  const col = pointGroup * 6 + sex * 3 + risk;

  const exactDecadeLabel = table[decadeIndex].decade;
  const exactPct = table[decadeIndex].values[col];

  let refLowLabel = "";
  let refLowPct = null;
  let refHighLabel = "";
  let refHighPct = null;

  if (decadeIndex > 0) {
    refLowLabel = table[decadeIndex - 1].decade;
    refLowPct = table[decadeIndex - 1].values[col];
  }
  if (decadeIndex < table.length - 1) {
    refHighLabel = table[decadeIndex + 1].decade;
    refHighPct = table[decadeIndex + 1].values[col];
  }

  let boundaryNote = "";
  if (age < 30) {
    boundaryNote = "Alder under ESC‑tabel — ekstrapoleret ud fra 30‑39 og 40‑49.";
  } else if (age > 80) {
    boundaryNote = "Alder over ESC‑tabel — ekstrapoleret ud fra 60‑69 og 70‑80.";
  } else if (age < 35) {
    boundaryNote = "Alder tæt på nedre grænse — primært baseret på 30‑39 og 40‑49.";
  } else if (age > 75) {
    boundaryNote = "Alder tæt på øvre grænse — primært baseret på 60‑69 og 70‑80.";
  }

  // ---- WRITE OUTPUT ----
  riskEl.textContent = `Risiko: ${value} %`;
  interpEl.textContent = text;

  nearestEl.textContent = `${exactDecadeLabel}: ${exactPct} %`;

  if (refLowPct !== null && refHighPct !== null) {
    refEl.textContent = `${refLowLabel}: ${refLowPct} % → ${refHighLabel}: ${refHighPct} %`;
  } else if (refLowPct !== null) {
    refEl.textContent = `${refLowLabel}: ${refLowPct} %`;
  } else if (refHighPct !== null) {
    refEl.textContent = `${refHighLabel}: ${refHighPct} %`;
  } else {
    refEl.textContent = "";
  }

  boundaryEl.textContent = boundaryNote;
}
</script>

</body>

</html>
